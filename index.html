<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AmpelFrei ‚Äî Weniger Ampeln, mehr Fahrt</title>
  <link rel="preconnect" href="https://maps.googleapis.com">
  <style>
    /* CSS bleibt unver√§ndert, da das Design perfekt passt */
    :root {
      --bg: #0f1115;
      --card: #121417;
      --muted: #9aa3b2;
      --accent: #00d084;
      --danger: #ff5252;
      --glass: rgba(255,255,255,0.03);
      --radius: 12px;
      --shadow: 0 4px 16px rgba(2,6,23,0.5);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      background: linear-gradient(180deg, #0b0c0e, #0f1115);
      color: #e6eef8;
      -webkit-font-smoothing: antialiased;
      font-size: 16px;
      display: flex;
      flex-direction: column;
      padding: 12px;
    }
    .app {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }
    header h1 {
      font-size: 20px;
      font-weight: 600;
    }
    header .sub {
      color: var(--muted);
      font-size: 14px;
      text-align: center;
    }
    .tab-nav {
      display: flex;
      gap: 8px;
      background: var(--glass);
      border-radius: var(--radius);
      padding: 4px;
      position: sticky;
      top: 12px;
      z-index: 10;
    }
    .tab-nav button {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .tab-nav button.active {
      background: var(--accent);
      color: #061012;
      font-weight: 600;
    }
    .tab-nav button:hover:not(.active) {
      background: rgba(255,255,255,0.05);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .panel {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .panel h2 {
      font-size: 16px;
      margin-bottom: 12px;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    label {
      color: var(--muted);
      font-size: 14px;
    }
    input[type="text"], select {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: inherit;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      width: 100%;
      min-height: 44px;
    }
    input::placeholder {
      color: rgba(255,255,255,0.3);
    }
    .small-btn, .action-btn, .primary {
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      min-height: 44px;
      text-align: center;
    }
    .small-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: inherit;
    }
    .primary {
      background: linear-gradient(90deg, var(--accent), #00c37a);
      color: #061012;
      border: none;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,208,132,0.15);
    }
    .action-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: inherit;
    }
    .action-btn.secondary {
      border-color: rgba(255,255,255,0.04);
    }
    .toggle-enabled {
      background: rgba(0,208,132,0.15);
      color: var(--accent);
      border: 1px solid rgba(0,208,132,0.2);
    }
    .toggle-disabled {
      background: rgba(255,82,82,0.08);
      color: var(--danger);
      border: 1px solid rgba(255,82,82,0.1);
    }
    .muted {
      color: var(--muted);
      font-size: 14px;
      margin-top: 12px;
    }
    .rides-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    .ride {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.04);
    }
    .ride .meta {
      font-size: 14px;
    }
    .ride .meta .sub {
      color: var(--muted);
      font-size: 12px;
    }
    #result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 14px;
    }
    #map {
      height: 300px;
      width: 100%;
      border-radius: var(--radius);
      margin-top: 12px;
    }
    @media (min-width: 600px) {
      .app {
        max-width: 800px;
      }
      header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .tab-nav {
        padding: 6px;
      }
      .tab-nav button {
        font-size: 16px;
      }
      .form-row {
        flex-direction: row;
        gap: 16px;
      }
      .panel {
        padding: 20px;
      }
      .panel h2 {
        font-size: 18px;
      }
    }
    @media (min-width: 900px) {
      .app {
        max-width: 1000px;
      }
    }
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <h1>AmpelFrei</h1>
        <div class="sub">Weniger Ampeln, fl√ºssiger fahren ‚Äî f√ºr Auto & Fahrrad</div>
      </div>
      <button id="reportTrafficLightBtn" class="small-btn">üö¶ Ampel melden</button>
    </header>
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="adhoc">Ad-hoc</button>
      <button class="tab-btn" data-tab="routes">Routen</button>
    </div>
    <div id="adhoc" class="tab-content active">
      <div class="panel" aria-live="polite">
        <h2>Ad-hoc-Berechnung</h2>
        <div class="form-row">
          <div class="field">
            <label>Startadresse</label>
            <input id="startAddress" type="text" placeholder="z. B. Musterstra√üe 1, 10115 Berlin" autocomplete="off">
          </div>
          <div class="field">
            <label>Zieladresse</label>
            <input id="destAddress" type="text" placeholder="z. B. Bahnhofstra√üe 5" autocomplete="off">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Transportmittel</label>
            <select id="travelMode">
              <option value="DRIVING" selected>Auto</option>
              <option value="BICYCLING">Fahrrad</option>
            </select>
          </div>
          <div class="field">
            <label>Routenpriorit√§t</label>
            <select id="routePriority">
              <option value="traffic_lights" selected>Wenigste Ampeln</option>
              <option value="fastest">Schnellste Route</option>
              <option value="shortest">K√ºrzeste Route</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <button class="primary" onclick="calculateRoute()">Berechnen: Beste Route finden</button>
          <button class="action-btn secondary" id="saveStartBtn">Start speichern</button>
          <button class="action-btn secondary" id="saveDestBtn">Ziel speichern</button>
        </div>
        <div id="map"></div>
        <div id="result" class="muted">Ergebnis erscheint hier.</div>
      </div>
    </div>
    <div id="routes" class="tab-content">
      <div class="panel">
        <h2>Neue Route</h2>
        <div class="form-row">
          <div class="field">
            <label>Titel</label>
            <input id="rideTitle" type="text" placeholder="z. B. Zur Arbeit">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Startadresse</label>
            <input id="rideOrigin" type="text" placeholder="Start (Autocomplete)">
          </div>
          <div class="field">
            <label>Zieladresse</label>
            <input id="rideDestination" type="text" placeholder="Ziel (Autocomplete)">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Transportmittel</label>
            <select id="rideTravelMode">
              <option value="DRIVING" selected>Auto</option>
              <option value="BICYCLING">Fahrrad</option>
            </select>
          </div>
          <div class="field">
            <label>Routenpriorit√§t</label>
            <select id="ridePriority">
              <option value="traffic_lights" selected>Wenigste Ampeln</option>
              <option value="fastest">Schnellste Route</option>
              <option value="shortest">K√ºrzeste Route</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <button class="primary" onclick="saveRoute()">Route speichern</button>
          <button class="action-btn secondary" onclick="clearRouteForm()">Form l√∂schen</button>
        </div>
        <div class="rides-list">
          <h3 style="margin: 12px 0 8px; font-size: 16px; color: #dfe9f3">Deine Routen</h3>
          <div id="routesList" class="rides-list"></div>
        </div>
      </div>
    </div>
  </div>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfmA_2wFMG2eXCJF0stxziBnM4CVNpoB0&libraries=places,directions"></script>
  <script>
    const KEY_ROUTES = 'ampelfrei_routes_v1';
    const KEY_START = 'ampelfrei_start_v1';
    const KEY_DEST = 'ampelfrei_dest_v1';
    let acStart, acDest, acRideOrigin, acRideDest;
    let map, directionsService, directionsRenderer;
    const CACHE = {};

    // Tab-Navigation
    document.querySelectorAll('.tab-btn').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(button.dataset.tab).classList.add('active');
      });
    });

    function showResult(msg, type) {
      const el = document.getElementById('result');
      el.innerHTML = msg;
      el.className = type ? type : 'muted';
    }

    function whenMapsReady(cb) {
      if (window.google && google.maps && google.maps.places && google.maps.directions) return cb();
      setTimeout(() => whenMapsReady(cb), 200);
    }

    whenMapsReady(() => {
      // Initialisiere Karte
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: { lat: 52.52, lng: 13.405 }, // Berlin als Default
        mapTypeControl: false,
        streetViewControl: false,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#212121" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
          { featureType: "road", elementType: "geometry", stylers: [{ color: "#3d3d3d" }] },
          { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9aa3b2" }] },
        ]
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
      acStart = new google.maps.places.Autocomplete(document.getElementById('startAddress'));
      acDest = new google.maps.places.Autocomplete(document.getElementById('destAddress'));
      acRideOrigin = new google.maps.places.Autocomplete(document.getElementById('rideOrigin'));
      acRideDest = new google.maps.places.Autocomplete(document.getElementById('rideDestination'));
    });

    function saveStart() {
      localStorage.setItem(KEY_START, document.getElementById('startAddress').value);
      showResult('Startadresse gespeichert');
    }

    function saveDest() {
      localStorage.setItem(KEY_DEST, document.getElementById('destAddress').value);
      showResult('Zieladresse gespeichert');
    }

    document.getElementById('saveStartBtn').onclick = saveStart;
    document.getElementById('saveDestBtn').onclick = saveDest;

    function loadRoutes() {
      const r = localStorage.getItem(KEY_ROUTES);
      return r ? JSON.parse(r) : [];
    }

    function saveRoutes(routes) {
      localStorage.setItem(KEY_ROUTES, JSON.stringify(routes));
      renderRoutes();
    }

    function clearRouteForm() {
      document.getElementById('rideTitle').value = '';
      document.getElementById('rideOrigin').value = '';
      document.getElementById('rideDestination').value = '';
      document.getElementById('rideTravelMode').value = 'DRIVING';
      document.getElementById('ridePriority').value = 'traffic_lights';
    }

    function saveRoute() {
      const routes = loadRoutes();
      const id = Date.now();
      const r = {
        id,
        title: document.getElementById('rideTitle').value || 'unnamed',
        originAddress: document.getElementById('rideOrigin').value,
        destinationAddress: document.getElementById('rideDestination').value,
        travelMode: document.getElementById('rideTravelMode').value,
        priority: document.getElementById('ridePriority').value,
        enabled: true
      };
      routes.push(r);
      saveRoutes(routes);
      clearRouteForm();
    }

    function deleteRoute(id) {
      const routes = loadRoutes().filter(r => r.id !== id);
      saveRoutes(routes);
    }

    async function getTrafficLights(points) {
      const cacheKey = points.map(p => `${p.lat}_${p.lng}`).join('|');
      if (CACHE[cacheKey]) return CACHE[cacheKey];
      let count = 0;
      for (const point of points) {
        const query = `[out:json];node["highway"="traffic_signals"](around:50,${point.lat},${point.lng});out;`;
        try {
          const response = await fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST',
            body: `data=${encodeURIComponent(query)}`
          });
          if (response.ok) {
            const data = await response.json();
            count += data.elements.length;
            data.elements.forEach(signal => {
              new google.maps.Marker({
                position: { lat: signal.lat, lng: signal.lon },
                map: map,
                icon: {
                  url: 'http://maps.google.com/mapfiles/ms/icons/red.png',
                  scaledSize: new google.maps.Size(20, 20)
                },
                title: 'Ampel'
              });
            });
          }
        } catch (e) {
          console.error('OSM Overpass Fehler:', e);
        }
      }
      CACHE[cacheKey] = count;
      return count;
    }

    async function calculateRoute() {
      showResult('üöó Berechne optimale Route...');
      const startVal = document.getElementById('startAddress').value;
      const destVal = document.getElementById('destAddress').value;
      const travelMode = document.getElementById('travelMode').value;
      const priority = document.getElementById('routePriority').value;

      if (!startVal || !destVal) {
        showResult('Bitte Start- und Zieladresse eingeben', 'danger');
        return;
      }

      console.group('üó∫Ô∏è AmpelFrei Berechnung: ' + startVal + ' ‚Üí ' + destVal);
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: startVal }, async (results1, status1) => {
        if (status1 !== 'OK' || !results1[0]) {
          showResult('Startadresse nicht gefunden', 'danger');
          console.groupEnd();
          return;
        }
        const loc1 = results1[0].geometry.location;
        geocoder.geocode({ address: destVal }, async (results2, status2) => {
          if (status2 !== 'OK' || !results2[0]) {
            showResult('Zieladresse nicht gefunden', 'danger');
            console.groupEnd();
            return;
          }
          const loc2 = results2[0].geometry.location;

          // Hole mehrere Routen von Google Maps
          directionsService.route({
            origin: startVal,
            destination: destVal,
            travelMode: google.maps.TravelMode[travelMode],
            provideRouteAlternatives: true
          }, async (result, status) => {
            if (status !== 'OK') {
              showResult('Route nicht gefunden', 'danger');
              console.groupEnd();
              return;
            }

            const routes = result.routes;
            let bestRoute = null;
            let minScore = Infinity;
            const routeDetails = [];

            for (let i = 0; i < routes.length; i++) {
              const route = routes[i];
              const leg = route.legs[0];
              const path = route.overview_path.map(p => ({ lat: p.lat(), lng: p.lng() }));
              const trafficLights = await getTrafficLights(path);
              const distance = leg.distance.value / 1000; // in km
              const duration = leg.duration.value / 60; // in Minuten
              let score;

              if (priority === 'traffic_lights') {
                score = trafficLights * 10 + distance; // Ampeln stark gewichten
              } else if (priority === 'fastest') {
                score = duration;
              } else {
                score = distance;
              }

              routeDetails.push({
                index: i,
                trafficLights,
                distance: distance.toFixed(1),
                duration: Math.round(duration),
                score
              });

              if (score < minScore) {
                minScore = score;
                bestRoute = { index: i, trafficLights, distance, duration };
              }
            }

            // Zeige beste Route auf der Karte
            directionsRenderer.setRouteIndex(bestRoute.index);

            // Ergebnis anzeigen
            let resultHtml = `<strong>Beste Route (${priority === 'traffic_lights' ? 'Wenigste Ampeln' : priority === 'fastest' ? 'Schnellste' : 'K√ºrzeste'}):</strong><br>`;
            resultHtml += `üö¶ ${bestRoute.trafficLights} Ampeln<br>`;
            resultHtml += `üìè ${bestRoute.distance} km<br>`;
            resultHtml += `‚è± ${bestRoute.duration} Minuten<br>`;
            resultHtml += `<br><strong>Alle Routen:</strong><br>`;
            routeDetails.forEach(r => {
              resultHtml += `Route ${r.index + 1}: ${r.trafficLights} Ampeln, ${r.distance} km, ${r.duration} Min<br>`;
            });
            showResult(resultHtml, 'success');

            console.log('Routen:', routeDetails);
            console.groupEnd();
          });
        });
      });
    }

    async function renderRoutes() {
      const list = document.getElementById('routesList');
      const routes = loadRoutes();
      list.innerHTML = routes.length ? '' : '<div class="muted">Keine Routen</div>';
      for (const r of routes) {
        const el = document.createElement('div'); el.className = 'ride';
        const left = document.createElement('div'); left.className = 'meta';
        left.innerHTML = `<strong>${r.title}</strong>
          <div class="sub">${r.originAddress} ‚Üí ${r.destinationAddress}</div>
          <div class="sub">${r.travelMode === 'DRIVING' ? 'Auto' : 'Fahrrad'} ¬∑ Priorit√§t: ${r.priority === 'traffic_lights' ? 'Wenigste Ampeln' : r.priority === 'fastest' ? 'Schnellste' : 'K√ºrzeste'}</div>
          <div class="sub" id="traffic_${r.id}">üö¶ Berechne...</div>`;
        const right = document.createElement('div');
        const toggle = document.createElement('button'); toggle.className = 'action-btn ' + (r.enabled ? 'toggle-enabled' : 'toggle-disabled'); toggle.textContent = r.enabled ? 'Aktiv' : 'Inaktiv';
        toggle.onclick = () => { r.enabled = !r.enabled; saveRoutes(loadRoutes().map(x => x.id === r.id ? r : x)); renderRoutes(); };
        const edit = document.createElement('button'); edit.className = 'action-btn'; edit.textContent = 'Bearbeiten'; edit.onclick = () => loadRouteIntoForm(r.id);
        const del = document.createElement('button'); del.className = 'action-btn secondary'; del.textContent = 'L√∂schen'; del.onclick = () => deleteRoute(r.id);
        right.appendChild(toggle); right.appendChild(edit); right.appendChild(del);
        el.appendChild(left); el.appendChild(right); list.appendChild(el);

        // Ampeln f√ºr gespeicherte Route berechnen
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: r.originAddress }, (results1, status1) => {
          if (status1 !== 'OK' || !results1[0]) return;
          geocoder.geocode({ address: r.destinationAddress }, async (results2, status2) => {
            if (status2 !== 'OK' || !results2[0]) return;
            directionsService.route({
              origin: r.originAddress,
              destination: r.destinationAddress,
              travelMode: google.maps.TravelMode[r.travelMode],
              provideRouteAlternatives: true
            }, async (result, status) => {
              if (status !== 'OK') return;
              const routes = result.routes;
              let bestRoute = null;
              let minScore = Infinity;
              for (let i = 0; i < routes.length; i++) {
                const path = routes[i].overview_path.map(p => ({ lat: p.lat(), lng: p.lng() }));
                const trafficLights = await getTrafficLights(path);
                const distance = routes[i].legs[0].distance.value / 1000;
                const duration = routes[i].legs[0].duration.value / 60;
                let score = r.priority === 'traffic_lights' ? trafficLights * 10 + distance : r.priority === 'fastest' ? duration : distance;
                if (score < minScore) {
                  minScore = score;
                  bestRoute = { index: i, trafficLights };
                }
              }
              const elp = document.getElementById(`traffic_${r.id}`);
              if (elp) elp.innerHTML = `üö¶ ${bestRoute.trafficLights} Ampeln`;
            });
          });
        });
      }
    }

    function loadRouteIntoForm(id) {
      const r = loadRoutes().find(x => x.id === id); if (!r) return;
      document.getElementById('rideTitle').value = r.title;
      document.getElementById('rideOrigin').value = r.originAddress;
      document.getElementById('rideDestination').value = r.destinationAddress;
      document.getElementById('rideTravelMode').value = r.travelMode;
      document.getElementById('ridePriority').value = r.priority;
      document.querySelector('.tab-btn[data-tab="routes"]').click();
    }

    // Button zum Melden einer Ampel (Platzhalter)
    document.getElementById('reportTrafficLightBtn').onclick = () => {
      showResult('üö¶ Ampel-Melden-Funktion: Bitte w√§hle einen Punkt auf der Karte (zuk√ºnftig implementiert)', 'muted');
    };

    // Init
    renderRoutes();
  </script>
</body>
</html>
